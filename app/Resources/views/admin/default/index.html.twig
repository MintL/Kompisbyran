{% extends 'base.html.twig' %}

{#% import _self as macro %}

{% macro connectionRequestItem(connectionRequest, inputName, isChecked, type) %}

    {% if type == 'musicfriend' %}
        {% set categories = connectionRequest.user.musicCategories %}
    {% else %}
        {% set categories = connectionRequest.user.categories %}
    {% endif %}


    <div class="col-md-6 col-sm-6 connection-request-item" data-categories="
        {%- for category in categories -%}
            {{ category.id }}{% if not loop.last %},{% endif %}
        {%- endfor -%}
    ">
        <div class="testimonial-content t-one">
            <h4>
                <img
                    style="width:50px"
                    src="{% if connectionRequest.user.profilePicture -%}
                            {{ connectionRequest.user.profilePicture }}
                        {%- else -%}
                            {{ asset('/images/user.png') }}
                        {%- endif %}"
                    alt=""
                    class="img-responsive img-circle"
                /><a
                    href="{{ path('admin_user', {'id': connectionRequest.user.id}) }}"
                    data-toggle="popover"
                    data-trigger="hover"
                    title="{{ connectionRequest.user.name }}"
                    data-html="true"
                    data-content="<strong>Från:</strong> {{ connectionRequest.user.from|country_name }}<br>
                    <strong>Antal kopplingar:</strong> {{ connectionRequest.user.connections|length }}<br>
                    <strong>Om:</strong> {{ connectionRequest.user.about }}"
                    data-placement="bottom"
                >{{ connectionRequest.user.name }}</a>
                <span>{{ connectionRequest.user.gender }}, {{ connectionRequest.user.age }} år</span>
            </h4>
            <blockquote class="{% if connectionRequest.user.internalComment %}br-orange{% else %}br-green{% endif %}">
                <p>
                    <input name="{{ inputName }}" value="{{ connectionRequest.id }}" type="radio"
                        {% if isChecked %}checked="checked"{% endif %}
                        data-name="{{ connectionRequest.user.name }} ({{ connectionRequest.user.gender }}, {{ connectionRequest.user.age }} år)"
                    >
                    {% for category in categories %}
                        {{ category.name }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    <br>
                    {{ connectionRequest.createdAt|date('Y-m-d') }}<br>
                    {{ connectionRequest.user.municipality.name }}<br>
                    {% if connectionRequest.comment %}
                        "<em>{{ connectionRequest.comment|nl2br }}</em>"<br>
                    {% endif %}
                    {{ connectionRequest.user.email }}
                </p>
                {% if connectionRequest.user.internalComment %}
                    <p>{{ connectionRequest.user.internalComment }}</p>
                {% endif %}
                <span class="text-right small">
                    <a href="{{ path('admin_connectionrequest', {'id': connectionRequest.id}) }}">Ändra</a>
                </span>

            </blockquote>
        </div>
    </div>
{% endmacro %#}

{% block stylesheets %}
    <link href="/css/dataTables.bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block body %}
    <div class="inner-page testimonial">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <div class="dropdown">
                        <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            <span class="selection">{{ 'match.select_region'|trans }}</span>
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                            {% for city in cities %}
                                <li>
                                    <a href="#" data-path="{{ path('admin_start', {'id': city.id}) }}" data-city-id="{{ city.id }}" data-city-name="{{ city.name }}">{{ city.name }}</a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-8">
                    <a href="#" class="btn btn-default btn-md">{{ 'match.find_matches'|trans }}</a>
                    <a href="#" class="btn btn-default btn-md">{{ 'match.manual_handling'|trans }}</a>
                    <a href="#" class="btn btn-default btn-md">{{ 'match.statistics'|trans }}</a>
                </div>
            </div>
            <div class="row" style="margin-top: 40px;">
                <div class="col-md-12">
                    <p>Hi! Right now we have <strong class="learners-num">{{ newUsers|length }} new</strong> &amp; <strong class="established-num">{{ establishedUsers|length }} established</strong> to match in <span class="stat-city-name">{{ city.name }}</span>. Thank you for helping out!</p>
                    <p>Last month we matched 30 people, so far we have matched 16 people this month.</p>
                </div>
            </div>
            <div class="row" style="margin-top: 40px;">
                <h1>1. Choose a person to find a match for</h1>
                <p>The people that have been waiting longest are displayed on top. "Match"-percentage tells you how good of a match the system could find.</p>
                <table id="example" class="table table-bordered" cellspacing="0" width="100%">
                    <thead>
                    {#<tr>
                        <th data-sort="createdAt" class="sortable-row"><span class="fa fa-angle-down"></span>{{ 'Date for request'|trans }}</th>
                        <th data-sort="firstName" class="sortable-row"><span class="fa fa-angle-down"></span> {{ 'Name'|trans }}</th>
                        <th data-sort="wantToLearn" class="sortable-row"><span class="fa fa-angle-down"></span> {{ 'Category'|trans }}</th>
                        <th>{{ 'Action'|trans }}</th>
                    </tr>#}
                    <tr>
                        <th id="request_date">{{ 'Date for request'|trans }}</th>
                        <th id="name">{{ 'Name'|trans }}</th>
                        <th id="category">{{ 'Category'|trans }}</th>
                        <th id="action">{{ 'Action'|trans }}</th>
                    </tr>
                    </thead>
                    <tbody class="persons-list-body"></tbody>
                </table>
                <div class="text-center">
                    <a href="#" class="btn btn-lg btn-default show-more-btn disabled" data-next-page="1">{{ 'Show 20 more'|trans }}</a>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    <script src="{{ asset('js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('js/jquery.blockUI.js') }}"></script>

    <script>
        $(document).ajaxStart(function(){
            $('#example').block({
                message: 'Loading...'
            });
        });

        $(document).ajaxStop(function(){
            $('#example').unblock();
        });

        $(document).ready(function() {

            var table = $('#example').DataTable({
                "paging": false,
                "bInfo": false,
                //"bFilter": false,
                columns:[
                    {data: 'request_date', width: '15%'},
                    {data: "name"},
                    {data: "category"},
                    {data: "action", width: '10%'}
                ],
                "createdRow": function ( row, data, index ) {
                    var id = $('td', row).eq(3).text();
                    $('td', row).eq(3).html('<a href="'+Routing.generate('admin_match_find', {id: id})+'" class="btn btn-danger">Find match</a>');
                }
            });

            $('.show-more-btn').on( 'click', function (e) {
                e.preventDefault();

                showMoreResults($('#dropdownMenu1').find('.selection').val(), $('.show-more-btn').data('next-page'));
            } );

            $(".dropdown-menu li a").click(function(){
                $(this).closest(".dropdown").find('.selection').text($(this).text());
                $(this).closest(".dropdown").find('.selection').val($(this).data('city-id'));

                table.clear();
                showMoreResults($(this).data('city-id'), 1);
            });

            var showMoreResults = function (id, page) {
                $.get(Routing.generate('ajax_by_city', {id: id, page: page}), function (resp) {

                    if (resp.success) {
                        if (resp.next) {
                            $('.show-more-btn').data('next-page', resp.next);
                            $('.show-more-btn').removeClass('disabled');
                        } else {
                            $('.show-more-btn').addClass('disabled', 'disabled');
                        }

                        table.rows.add(resp.results).draw();
                    }
                });
            }

            // Automatically add a first row of data
            //$('.show-more-btn').click();
        });
    </script>
{% endblock %}
